#!/bin/bash
# Launcher script for Rustorrent - starts the app and opens the web UI
#
# The key to staying in the Dock: exec replaces this shell with rustorrent-bin
# so macOS tracks the real binary as the .app process.

# Get the directory where this script lives (inside .app/Contents/MacOS/)
APP_DIR="$(cd "$(dirname "$0")" && pwd)"
BINARY="$APP_DIR/rustorrent-bin"
UI_PORT=9473
UI_URL="http://127.0.0.1:$UI_PORT"
LOG_FILE="$HOME/.rustorrent/launcher.log"
DOWNLOAD_DIR="$HOME/Downloads"

# Ensure PATH includes common locations
export PATH="/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:$PATH"

# Create log directory
mkdir -p "$HOME/.rustorrent"

# Log function
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') $1" >> "$LOG_FILE"
}

log "Launcher started"
log "APP_DIR: $APP_DIR"
log "BINARY: $BINARY"

# Get the torrent file if one was passed (ignore Finder process serial argument)
TORRENT_FILE=""
for arg in "$@"; do
    if [[ "$arg" == -psn_* ]]; then
        continue
    fi
    if [[ "$arg" == *.torrent ]] && [[ -f "$arg" ]]; then
        TORRENT_FILE="$arg"
        break
    fi
done
if [[ -n "$TORRENT_FILE" ]]; then
    log "Torrent file: $TORRENT_FILE"
fi

# Check if rustorrent is already running on this port
if /usr/bin/curl -s --connect-timeout 1 "$UI_URL" >/dev/null 2>&1; then
    log "Already running, opening browser"
    if [[ -n "$TORRENT_FILE" ]]; then
        /usr/bin/curl -s -X POST -H "Content-Type: application/x-bittorrent" \
            --data-binary "@$TORRENT_FILE" \
            "$UI_URL/add-torrent" >/dev/null 2>&1
    fi
    /usr/bin/open "$UI_URL"
    exit 0
fi

# Start rustorrent
log "Starting rustorrent..."
cd "$HOME"
mkdir -p "$DOWNLOAD_DIR"

# Background task: poll until UI is ready, then open browser
(
    for i in {1..30}; do
        if /usr/bin/curl -s --connect-timeout 1 "$UI_URL" >/dev/null 2>&1; then
            log "UI is ready, opening browser"
            /usr/bin/open "$UI_URL"
            break
        fi
        sleep 0.2
    done
) &

# exec replaces this shell with the actual binary.
# macOS tracks this PID as the .app process â†’ stays in the Dock.
if [[ -n "$TORRENT_FILE" ]]; then
    exec "$BINARY" "$TORRENT_FILE" --ui --ui-addr "127.0.0.1:$UI_PORT" --download-dir "$DOWNLOAD_DIR" --log "$LOG_FILE" >> "$LOG_FILE" 2>&1
else
    exec "$BINARY" --ui --ui-addr "127.0.0.1:$UI_PORT" --download-dir "$DOWNLOAD_DIR" --log "$LOG_FILE" >> "$LOG_FILE" 2>&1
fi
