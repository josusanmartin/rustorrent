name: release-gate

on:
  push:
    branches: [main, master]
  pull_request:
  workflow_dispatch:

jobs:
  test-matrix:
    name: test (${{ matrix.os }} / ${{ matrix.label }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            label: core
            features: --no-default-features --features core
          - os: ubuntu-latest
            label: full
            features: --all-features
          - os: ubuntu-latest
            label: selective
            features: --no-default-features --features core,udp_tracker,dht,lpd,utp,mse,natpmp,upnp,webseed
          - os: macos-latest
            label: core
            features: --no-default-features --features core
          - os: macos-latest
            label: full
            features: --all-features
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
      - name: Run tests
        run: cargo test ${{ matrix.features }}

  adversarial-process:
    name: adversarial process tests
    runs-on: ubuntu-latest
    needs: test-matrix
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
      - name: Run process-level adversarial tests
        run: cargo test --all-features --test process_release_gate

  fuzz-smoke:
    name: fuzz smoke
    runs-on: ubuntu-latest
    needs: test-matrix
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - name: Install nightly toolchain
        uses: dtolnay/rust-toolchain@nightly
      - name: Install cargo-fuzz
        run: cargo +nightly install cargo-fuzz --locked
      - name: Fuzz bencode parser
        working-directory: fuzz
        run: cargo +nightly fuzz run bencode_parse -- -max_total_time=20
      - name: Fuzz peer decoder
        working-directory: fuzz
        run: cargo +nightly fuzz run peer_decode_message -- -max_total_time=20
      - name: Fuzz http/tracker parsers
        working-directory: fuzz
        run: cargo +nightly fuzz run http_tracker_parsers -- -max_total_time=20

  soak:
    name: soak swarm
    runs-on: ubuntu-latest
    needs: test-matrix
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
      - name: Run soak/load simulation
        env:
          RUSTORRENT_SOAK_SECS: "20"
        run: cargo test --all-features --test soak_swarm -- --ignored --nocapture
